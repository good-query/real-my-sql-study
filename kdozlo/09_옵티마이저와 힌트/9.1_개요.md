# 9.1 개요

## 9.1.1 쿼리 실행 절차

1. 사용자가 전송한 SQL 문장을 MySQL 서버가 처리 가능한 형태로 분석한다.
2. SQL의 파싱 정보를 기반으로 실행 계획을 수립한다.
3. 실행 계획에 따라 스토리지 엔진에서 데이터를 읽고, 필요한 연산을 수행하여 결과를 반환한다.

---

### 1단계: SQL Parsing
- MySQL 서버 레이어의 SQL 파서 모듈이 처리
- SQL 문장을 토큰화 및 구문 분석
- 문법 오류를 체크하고 SQL parse tree를 생성
- 이 parse tree는 이후 단계에서 실행 계획 수립에 사용됨

### 2단계: 최적화 및 실행 계획 수립
- MySQL 서버 레이어의 옵티마이저가 처리
- SQL parse tree를 기반으로 다음 최적화 수행:
    - 불필요한 조건 제거 및 표현식 단순화
    - 조인이 포함된 경우, 테이블 읽기 순서 결정
    - 통계 정보와 인덱스 정보를 기반으로 적절한 인덱스 선택
    - 커버링 인덱스 여부 판단
    - 서브쿼리 변환, 세미조인 최적화 등도 수행
    - 임시 테이블 필요 여부 결정
- 최종 실행 계획 생성

### 3단계: 실행
- 수립된 실행 계획에 따라 스토리지 엔진 레이어에 레코드 조회 요청
- 스토리지 엔진은 인덱스 및 테이블에서 필요한 데이터를 읽어 MySQL 서버로 전달
- MySQL 서버 레이어는 전달받은 데이터로 조인, 정렬, 집계, 필터링 등의 연산 수행
- 최종 결과를 클라이언트에 반환

> 참고: 1, 2단계는 대부분 MySQL 서버 레이어에서 처리되며, 3단계는 서버 레이어와 스토리지 엔진 레이어가 협력하여 수행됨


## 9.1.2 옵티마이저의 종류
- 옵티마이저 == 데이터베이스 서버의 두뇌 역할
- 비용 기반 최적화 방법(Cost-based optimizer, CBO)
    - 현재 대부분의 DBMS가 선택
- 규칙 기반 최적화 방법(Rule-based optimizer, RBO) 
    - 초기 버전의 오라클 DBMS에서 많이 사용
    - 각 테이블이나 인덱스의 통계 정보가 거의 없고, 상대적으로 느린 CPU 연산 환경에서 비용 계산 과정이 부담스러울 때 사용되던 방식

### 비용 기반 최적화
1. 옵티마이저가 쿼리를 처리할 수 있는 다양한 실행 계획 후보를 생성한다.  
2. 테이블 및 인덱스의 통계 정보를 활용해 각 실행 계획의 예상 비용을 계산한다.  
3. 추정된 실행 계획 중 가장 낮은 비용을 가진 계획을 선택하여 쿼리를 실행한다.

### 규칙 기반 최적화
- 대상 테이블의 레코드 건수나 선택도 등을 고려 X
- 옵티마이저에 내장된 우선순위에 따라 실행 계획을 수립하는 방식
- 통계 정보(테이블의 레코드 건수나 칼럼값의 분포도) 조사 하지 않고 실행 계획 수립 
    - -> 같은 쿼리에 대해서 거의 항상 같은 실행 방법 만든다.
- 사용자의 데이터는 분포도가 다양 -> 규칙 기반 최적화 거의 사용 X
