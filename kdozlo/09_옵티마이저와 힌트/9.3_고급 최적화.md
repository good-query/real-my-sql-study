# 9.3 고급 최적화

## 9.3.1 옵티마이저 스위치 옵션
- MySQL 서버의 고급 최적화 기능들을 활성화할지를 제어하는 용도로 사용
- `optimizer_switch` 시스템 변수로 제어
- 옵티마이저 스위치 옵션은 `default`, `on`, `off` 중 하나 설정 가능
- e.g. 
    ```sql
    -- MySQL 서버 전체적으로 옵티마이저 스위치 결정
    SET GLOBAL optimizer_switch='index_merge-on,indext_merge_union=on, ...';

    -- 현재 커넥션의 옵티마이저 스위치 결정
    SET SESSION optimizer_switch='index_merge-on,indext_merge_union=on, ...';

    -- 현재 쿼리만 적용
    SELECT /*+ SET_VAR(optimizer_switch='condition_fanout_filter=off') */
    ...
    FROM ...
    ;
    ```
### 옵티마이저 스위치 종류
<img src="../images/9.3_고급%20최적화/2025-07-16-06-29-06.png" style="width: 100%; max-width: 500px; height: auto;" />

- [MySQL 8.4 Document](https://dev.mysql.com/doc/refman/8.4/en/server-system-variables.html#sysvar_named_pipe_full_access_group)

### 9.3.1.1 MRR과 배치 키 액세스(mrr & batched_key_access)
- MRR: Mulit-Range Read
    - DS-MRR(Disk Sweep Multi-Range Read)라고도 함
    - 드라이빙 테이블을 스캔하며, 조인 조건에 맞는 드리븐 테이블의 인덱스 키(rowid)를 버퍼링한다.
    - 버퍼가 가득 차면, 모은 키들을 rowid 순으로 정렬한 뒤, 정렬된 순서대로 순차 I/O 방식으로 드리븐 테이블의 데이터를 한꺼번에 읽어 와 조인 처리하는 방식.
    - NL 조인 단점 보완
        - 드라이빙 테이블 레코드 하나 당 드리븐 테이블 데이터 찾아서 조인 방식
        - 드리븐 테이블 데이터 조회 과정을 스토리지 엔진이 담당하여 최적화 수행 불가능 단점 존재
- BKA(Batched Key Access): MRR 응용해서 실행되는 조인 방식
    - BKA 조인 최적화 defualt 비활성화 
        - BKA 단점 때문
        - BKA 사용시, 부가적인 정렬 작업이 필요해져 성능에 악영향 가능성 존재 -> 필요한 곳에서만 쓰는 것 권장

### 9.3.1.2 블록 네스티드 루프 조인(block_nested_loop)
- 조인 버퍼 사용 여부와 드라이빙 테이블과 드리븐 테이블 조인 순서가 NL 조인과 다르다.
- 실행 계회의 Extra에서 `Using Join buffer` 표시됨
- 드리븐 테이블의 풀 테이블 스캔이나 인덱스 풀 스캔을 피할 수 없는 경우, 드라이빙 테이블에서 읽은 레코드를 메모리(조인 버퍼)에 캐시하여 사용
- `join_buffer_size`로 크기 제한 가능
- 조인 완료시 조인 버퍼 해제
- MySQL 8.0.18부터 해시 조인 알고리즘 도입 -> MySQL 8.0.20 부터 BNL 사용X, 해시 조인이 대체

### BNL 예시

```sql
SELECT * FROM dept_emp de, employees e
WHERE de.from_date > '1995-01-01' AND e.emp_no < 109004;
```

<img src="../images/9.3_고급%20최적화/2025-07-16-08-46-29.png" style="width: 90%; max-width: 500px; height: auto;" />

<img src="../images/9.3_고급%20최적화/2025-07-16-08-47-02.png" style="width: 90%; max-width: 500px; height: auto;" />

1. 드라이빙 테이블인 dept_no의 ix_formdate 인덱스를 이용해 조건에 만족하는 레코드를 검색
2. 조인에 필요한 나머지 칼럼을 모두 dept_emp 테이블로부터 읽어서 조인 버퍼에 저장
3. employees 테이블의 프라이머리 키를 이용해 조건을 만족하는 레코드를 검색
4. 3번에서 검색된 결과에 2번의 조인 버퍼의 레코드를 결합해서 반환한다.

- 조인의 순서가 거꾸로인 것처럼 실행된다.
    - 드리븐 테이블인 employees 테이블의 결과를 기준으로 dept_emp 테이블의 결과를 병합
- 조인 버퍼 사용 조인에서는 결과의 정렬 순서가 흐트러질 수 있다.
