name: í´ë” íŠ¸ë¦¬ ìš”ì •

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ 00:00 ì‹¤í–‰

permissions:
  contents: write
  pull-requests: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Replace tree block in README.md
        run: |
          START="<!--TREE START-->"
          END="<!--TREE END-->"

          declare -A printed_dirs
          PREV_TOP_LEVEL=""
          > README_TREE.md

          find . \
            -path './.git' -prune -o \
            -path './.github' -prune -o \
            -path './README_TREE.md' -prune -o \
            -path './FOLDER_TREE.md' -prune -o \
            -type f -name "*.md" -print \
          | sort \
          | while read -r filepath; do
            rel_path="${filepath#./}"
            IFS='/' read -ra parts <<< "$rel_path"
            indent=""
            path_accum=""

            top_level="${parts[0]}"
            if [[ "$top_level" != "$PREV_TOP_LEVEL" ]]; then
              echo "" >> README_TREE.md
              PREV_TOP_LEVEL="$top_level"
            fi

            for ((i=0; i<${#parts[@]}-1; i++)); do
              part="${parts[$i]}"
              path_accum="${path_accum}/${part}"
              key="${path_accum#/}"

              if [[ -z "${printed_dirs[$key]}" ]]; then
                echo "${indent}- ${part}/" >> README_TREE.md
                printed_dirs[$key]=1
              fi
              indent="$indent  "
            done

            filename="${parts[-1]}"
            link=$(echo "$rel_path" | sed 's| |%20|g')
            echo "${indent}- ğŸ“„ [${filename}](${link})" >> README_TREE.md
          done

          # ğŸ§  README.md ì™„ì „íˆ ìƒˆë¡œ ë§Œë“¤ì–´ì„œ ë®ì–´ì“°ê¸°
          awk -v s="$START" -v e="$END" '
            BEGIN {
              while ((getline line < "README_TREE.md") > 0) tree = tree line "\n"
            }
            {
              if ($0 ~ s) { print s; print tree; inblock=1; next }
              if ($0 ~ e) { print e; inblock=0; next }
              if (!inblock) print
            }
          ' README.md > README.tmp && mv README.tmp README.md

          echo "âœ… README.md ìµœì¢… ë‚´ìš© í™•ì¸"
          cat README.md
  
      - name: Create dynamic commit/branch title
        id: pr_context
        run: |
          YEAR=$(date +%Y)
          MONTH=$(date +%-m)
          DAY=$(date +%-d)
          FIRST_DAY_WEEKDAY=$(date -d "$YEAR-$MONTH-01" +%u)
          WEEK_NUM=$(( (DAY + FIRST_DAY_WEEKDAY - 1) / 7 + 1 ))
          TITLE="ğŸ“ Update folder structure - ${MONTH}ì›” ${WEEK_NUM}ì£¼ì°¨"
          BRANCH="update-folder-tree-$(date +'%Y%m%d-%H%M%S')"
          echo "TITLE=$TITLE" >> $GITHUB_OUTPUT
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          echo "COMMIT=ğŸ“ í´ë” êµ¬ì¡° ì—…ë°ì´íŠ¸ - ${MONTH}ì›” ${WEEK_NUM}ì£¼ì°¨" >> $GITHUB_OUTPUT

      - name: Create branch and push
        run: |
          git checkout -b ${{ steps.pr_context.outputs.BRANCH }}
          git config user.name "í´ë” ì •ë¦¬ ìš”ì • ğŸ¤–"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add README.md
          git commit -m "${{ steps.pr_context.outputs.COMMIT }}" || echo "â— ë³€ê²½ëœ ë‚´ìš© ì—†ìŒ"
          git push -u origin ${{ steps.pr_context.outputs.BRANCH }}
      - name: Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.pr_context.outputs.BRANCH }}
          base: main
          title: ${{ steps.pr_context.outputs.TITLE }}
          body: "ğŸ§¹ ìë™ ìƒì„±ëœ í´ë” êµ¬ì¡°ë¥¼ ë°˜ì˜í•©ë‹ˆë‹¤.\në¦¬ë·° í›„ ë³‘í•©í•´ì£¼ì„¸ìš”!"
          delete-branch: true
          reviewers: |
            limsubinn
            kdozlo
            dalcheonroadhead
          labels: |
            AUTO-UPDATE ğŸ¤–
          add-paths: |
            README.md  # âœ… ì´ê±° ë°˜ë“œì‹œ ëª…ì‹œí•´ì•¼ ë„ˆì˜ ê¸°ì¡´ ì»¤ë°‹ì´ ë®ì´ì§€ ì•ŠìŒ

  
