name: update folder tree

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ 00:00 ì‹¤í–‰

permissions:
  contents: write
  pull-requests: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Replace tree block in README.md
        run: |
          START="<!--TREE START-->"
          END="<!--TREE END-->"
          
          # íŠ¸ë¦¬ ë¬¸ìì—´ì„ ë¨¼ì € ë³€ìˆ˜ì— ë‹´ëŠ”ë‹¤ (HEREDOC ì‚¬ìš©)
          TREE_CONTENT=$(find . -type f -name "*.md" \
            | grep -vE '^\.\/(\.github|\.git|README\.md|FOLDER_TREE\.md)$' \
            | sort \
            | while read -r path; do
                depth=$(echo "$path" | awk -F"/" '{print NF-1}')
                indent=""
                for ((i=1; i<=depth; i++)); do indent="$indentâ”‚   "; done

                symbol="â”œâ”€ ğŸ“„"
                if [ "$(basename "$path")" = "$(basename "$(find "$(dirname "$path")" -maxdepth 1 -type f -name '*.md' | sort | tail -n 1)")" ]; then
                  symbol="â””â”€ ğŸ“„"
                fi

                # íŒŒì¼ëª…ê³¼ ë§í¬ì£¼ì†Œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                filename=$(basename "$path")
                link=${path#./}
                link_escaped=$(echo "$link" | jq -sRr @uri)  # URL ì¸ì½”ë”©

                echo "${indent}${symbol} [${filename}]($link_escaped)"
              done)

          # awkë¡œ README ë‚´ìš© êµì²´
          awk -v s="$START" -v e="$END" -v content="$TREE_CONTENT" '
            $0 ~ s {
              print
              print content
              next
            }
            $0 ~ e { print; next }
            !($0 ~ s || $0 ~ e)
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Create dynamic commit/branch title
        id: pr_context
        run: |
          YEAR=$(date +%Y)
          MONTH=$(date +%-m)
          DAY=$(date +%-d)
          FIRST_DAY_WEEKDAY=$(date -d "$YEAR-$MONTH-01" +%u)
          WEEK_NUM=$(( (DAY + FIRST_DAY_WEEKDAY - 1) / 7 + 1 ))
          TITLE="ğŸ“ Update folder structure - ${MONTH}ì›” ${WEEK_NUM}ì£¼ì°¨"
          BRANCH="update-folder-tree-$(date +'%Y%m%d-%H%M%S')"
          echo "TITLE=$TITLE" >> $GITHUB_OUTPUT
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          echo "COMMIT=ğŸ“ í´ë” êµ¬ì¡° ì—…ë°ì´íŠ¸ - ${MONTH}ì›” ${WEEK_NUM}ì£¼ì°¨" >> $GITHUB_OUTPUT

      - name: Create branch and push
        run: |
          git checkout -b ${{ steps.pr_context.outputs.BRANCH }}
          git config user.name "GitHub Actions"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add README.md
          git commit -m "${{ steps.pr_context.outputs.COMMIT }}" || echo "â— ë³€ê²½ëœ ë‚´ìš© ì—†ìŒ"
          git push -u origin ${{ steps.pr_context.outputs.BRANCH }}
