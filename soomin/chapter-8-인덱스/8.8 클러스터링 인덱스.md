---
tags:
  - 데이터베이스
  - cs
parent: "[[인덱스]]"
related: 
created: 2025-06-07
---

# 0. 학습 목적
- 클러스터링 인덱스의 어원, 정의, 존재 이유를 이해한다.

# 1. 클러스터링 인덱스란? 
- 프라이머리 키(PK)가 인덱스의 컬럼 키인 B-Tree 인덱스
- 리프노드가 레코드가 있는 주소가 아닌, 실제 데이터를 저장하고 있는 인덱스

# 2. 클러스터링 인덱스의 특징
- InnoDB는 데이터 파일 부분이 클러스터링 인덱스로 이루어져 있다.
- 특정 레코드의 PK 값이 변경되면, 데이터 파일의 저장 위치도 바뀐다. 
- 만약 InnoDB에서 PK 키를 따로 설정하지 않았다면, innodb 스토리지엔진이 다음 기준에 따라 데이터를 클러스터링 해서 저장한다.
	- NOT NULL + 유니크한 컬럼들 중 가장 첫번쨰로 오는 컬럼을 컬럼 키로 잡고 클러스터링 인덱스를 만든다.
	- NOT NULL + 유니크한 컬럼이 없다면, 레코드 별로 유일무이한 값을 가지도록 증가되는 컬럼을 내부적으로 추가한 후 클러스터링 인덱스를 만든다. (해당 컬럼은 사용자에게 보이지 않는다.)

## (1) InnoDB의 데이터 파일 부분 모습 

### A. 다른 스토리지 엔진의 경우
다른 스토리지엔진은 인덱스와 데이터 파일이 분리되어 있다. 
레코드는 데이터파일의  끝 (혹은 임의의 공간)에 저장되고 다시는 위치가 바뀌지 않는다. 
인덱스의 리프노드는 그 바뀌지 않는 데이터파일의 위치 주소(= ROWID) 를 가리킨다.
![image.png](https://raw.githubusercontent.com/dalcheonroadhead/img-cloud/main/2025-05/20250607215050.png)

### B. InnoDB의 경우
데이터 파일 내부에 데이터를 저장할 때, 밑의 그림처럼 PK가 컬럼키인 B-Tree 형태로 저장한다.
B-Tree의 리프노드는 실제 데이터를 가지고 있다.

> 이렇게 클러스터링 형태로 저장된 테이블을 클러스터링 테이블이라 부른다.
> InnoDB의 모든 테이블은 클러스터링 테이블이다.

![image.png](https://raw.githubusercontent.com/dalcheonroadhead/img-cloud/main/2025-05/20250607215305.png)

## (2) PK 값이 달라지면, 레코드의 저장 위치도 변경
![image.png](https://raw.githubusercontent.com/dalcheonroadhead/img-cloud/main/2025-05/20250607221511.png)

emp_no가 PK인 직원 테이블이 있다. 그리고, 그것의 클러스터링 인덱스는 위와 같다.
원래 위와 같이, 페이지 번호 2에 100001, 100003, 1000004 번이 저장되고, 페이지 번호 3에 100005  ~ 100007 번이 저장된다고 해보자.

이때 100007번을 100002번으로 바꾸어보자.
![image.png](https://raw.githubusercontent.com/dalcheonroadhead/img-cloud/main/2025-05/20250607221900.png)

위와 같이 바뀐다. 

물론 PK를 바꿀 일은 거의 없겠지만, 이 특성을 통해 알아둬야 할 것은,
**클러스터링형 인덱스는 innodb의 데이터 저장 방식이라는 점이다.**

## (3) PK 값을 안 만들면? 
위에 기술한 원칙대로, innodb 엔진은 어쨌든 내부적으로 PK를 만들어 관리한다. 
이렇게 하면 다음과 같은 이득을 잃게 된다.

- innodb가 스스로 설정한 PK는 외부에 보이지 않는다. -> 이것을 활용해 쿼리 문장을 짤 수가 없다. -> 가장 빠른 검색인 PK 활용 검색을 하지 못한다. -> 서비스 퍼포먼스 손해

# 핵심 요약

- 클러스터링 인덱스는 PK를 컬럼 키로 가지는 B-Tree 인덱스로, 특이점은 리프노드가 실제 데이터를 가진다는 점이다.
- mySQL의 innoDB는 모든 데이터를 클러스터링 인덱스로 저장한다. 
- 따라서 클러스터링 인덱스는 데이터의 저장 방식도 된다. (PK가 바뀌면, 데이터의 저장 위치도 바뀜) 
- PK를 사용자가 명시적으로 설정하지 않으면 innodb 엔진이 내부적으로 설정하는데, 이렇게 되면 PK를 활용한 쿼리문을 만들지 못해서, 검색에서 큰 손해를 본다.

---

# Metadata

### A. 모르는 단어 정리

- `클러스터링 (Clustering)`
  : 비슷한 것 끼리 모으다. 군집화를 뜻한다.
  
	- 왜 컬럼 키가 PK이고, 리프노드에 실 데이터를 가진 저 인덱스를 클러스터링 인덱스라 부를까? 
	  :PK가 비슷한 값끼리 모아놔서
	  (물론 모든 B-tree가 '클러스터링 하고 있지만, innodb에서 데이터를 저장하는 방식인 위의 인덱스만 구분되게 **`클러스터링 인덱스`** 라고 부른다.'
	  
	- 이렇게 클러스터링을 하는 이유는 무엇일까? 
	   : 비슷한 값들을 동시에 조회하는 경우가 많음을 인지하고, 이러한 상황들에서 유리하기 위해

###  B. 참고 문서
- real-my-sql 8.8.1  

### C. 자식 글

```dataview
TABLE without id file.inlinks AS "BackLink"
WHERE file.path = this.file.path
```
