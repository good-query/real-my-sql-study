<h1 align='center'> 4️⃣ 버퍼 풀 플러시 </h1>

## (0) 들어가며...

MySQL 5.6 버전 전까지는 InnoDB 스토리지의 더티 페이지 플러시 기능이 부드럽지가 않아서, 갑작스러운 디스크 쓰기 폭증이 자주 발생해 사용자 쿼리 처리 성능에 영향을 주는 경우가 많았다. 하지만 mySQL 8.0부터는 다른 성능상의 악영향 없이 디스크에 동기화하기 위해 다음과 같이 2개의 플러시 기능을 백그라운드로 실행 했다.

## (1) 플러시 리스트 플러시 (변경된 데이터를 동기화)

플러시 리스트는 더티 페이지들의 목록을 들고 있는 자료구조로, 연결된 리두 로그가 누적되어서 리두 로그 파일을 가득 채우는 일이 없게 정기적으로 오래된 더티페이지를 플러시 해줘야 한다. (그래야 연결된 리두 로그도 사용되고, 재활용 가능한 공간으로 바뀐다.)  **이를 위해** InnoDB 스토리지 엔진은 주기적으로 플러시 리스트 플러시 함수를 호출해서 오래된 더티 페이지 부터 순차적으로 디스크에 동기화 하고 있다. 

### 플러시 리스트에 적힌 명부를 어떻게 플러시? 

클리너 스레드라는 청소부가 존재한다. 이 녀석이 더티 페이지가 들어 있는 버퍼 풀 인스턴스를 찾아가서 더티페이지를 하나씩 디스크에 동기화 한다. 표준 설정은 하나의 클리너 스레드가 하나의 버퍼 풀 인스턴스에 대한 플러시를 담당하지만, 클리너 스레드 개수가 작으면 하나가 여러 개의 인스턴스를 담당한다.

### 버퍼 풀은 더티 페이지를 얼마나 가질 수 있고, 얼마나 가지는 게 좋은가?

전체 버퍼 풀의 가진 페이지 중 90%까지 더티 페이지를 가질 수 있다. 더티 페이지를 많이 가지고 있을수록 디스크 쓰기 작업을 버퍼링함으로써 여러 번의 디스크 쓰기를 한 번으로 줄이는 효과를 극대화 할 수 있다.

### 그렇다고 너무 많이 가지면? 

만약에 디스크에 더티 페이지를 동기화 하는 속도보다 더티페이지가 버퍼 풀에 새로 차는 속도가 더 크면, InnoDB는 급작스럽게 더티페이지를 다시 동기화해야 한다고 판단한다. 그러면 갑작스러운 디스크 쓰기 폭증하는 현상이 생긴다. 이러면 CPU 과부하가 커진다. 

## (2) LRU 리스트 플러시 (조회가 안되는 데이터를 삭제)

LRU 리스트에서 사용빈도가 낮은 데이터 페이지들을 제거해서 새로운 페이지를 읽어올 공간을 만들어 내는 플러시이다 .여기에는 LRU 리스트 플러시 함수가 사용된다. InnoDB 스토리지 엔진은 LRU 리스트의 끝부분 부터 시작해서 최대 `innodb_lru_scan_depth` 시스템 변수에 설정된 개수 만큼의 데이터를 스캔한다. 스캔 하면서 더티 페이지는 디스크에 동기화하고 LRU 리스트에서 제외, 클린 페이지는 즉시 프리 리스트로 옮기고 해당 페이지의 데이터를 삭제한다.



### 막간 영어 타임

`flush? :` 씻어내다. 라는 뜻을 가짐. 생활 용어로는 변기물을 내리다라는 의미로 쓰인다.

