---
tags:
  - 데이터베이스
  - cs
parent: "[[InnoDB 아키텍처]]"
related:
  - "[[실행 계획 - ORDER BY 처리]]"
created: 2025-06-25
---

# 0. 학습 목적
- 소트 버퍼가 무엇인지와 아키텍쳐 내에서의 역할을 이해한다.
- `filesort` 시 소트 버퍼를 어떻게 활용하여 레코드들을 정렬하는지 이해한다.
- 소트 버퍼 크기는 어느 정도가 적절한지 이해한다.

# 1. 소트 버퍼란? 
- 질의문 결과 레코드들의 정렬을 위해 쓰이는 별도의 세션 메모리 공간
- 항시 할당 상태는 아니고, 필요한 경우 할당 받아 활용되고, 정렬이 끝나면 다시 반납한다.
  (이때 소트 버퍼의 사이즈는 `sort_buffer_size`를 넘지 못한다.)

# 2 소트 버퍼 정렬 과정

1. 메모리 할당 -> 실행 계획이 `using filesort`이면, 메모리 공간에 sort buffer 공간이 할당된다.
2. 데이터 수집 -> 조건에 맞는 데이터들이 해당 buffer에 적재된다.
3. 데이터 정렬
	- 정렬할 데이터량 < sort_buffer_size
	  : quick_sort로 한 방에 정리가 됨. 
	  
	- 정렬할 데이터 량 > sort_buffer_size
	  이 병합작업을 `Multi-merge` 라고 부름 
		1. 정렬할 수 있는 양 만큼만 sort buffer에 적재
		2. quick-sort로 정렬 후 정렬된 데이터들을 임시 파일 형태로 디스크에 저장 
		3. 모든 임시 파일들을 상대로 merge_sort
		   
4. 결과 값 반환

> [!note] 레코드 건 수와 성능의 관계
> 정렬해야할 레코드 건 수가 buffer_size보다 크면, 디스크 쓰기, 읽기 작업이 필연적으로 생긴다. 
> 따라서 정렬해야할 레코드 건 수가 많을수록 디스크 쓰기/읽기가 잦아지고, 정렬 성능이 느려진다.

# 3. 소트 버퍼 사이즈 설정
`sort_buffer_size` 크기를 늘리면 정렬을 위한 소트버퍼 할당 시 그 크기가 커진다. 

## (1) 소트 버퍼 사이즈를 키울수록 성능이 좋아질까? 
아니다. 
real-my-sql에서 벤치마크로 소트 버퍼 크기에 따른 성능 체크를 해보았지만, 성능이 좋아지지 않았다. 
트랜잭션 처리용 MySQL 서버에서는 `56KB` ~ `1MB` 미만이 적절해 보인다고 필자는 말한다.

## (2) 소트 버퍼 사이즈를 키울 때 생길 수 있는 부작용
위 설명에서 **소트 버퍼는 세션 메모리 영역에 할당**된다고 했다.
따라서 세션 메모리 영역을 키울수록, $활성화된 \; 세션 \; 메모리 \; 수 \;  \times sort \; buffer \; size$  만큼의 메모리 공간이 정렬을 위해 사용되는 것이다.

이는 빠르게 메모리 공간 부족을 야기할 수 있다. 
메모리 공간 부족이 일면 OS에서 메모리 여유 공간 확보를 위해 OOM-Killer를 작동시켜 프로세스를 강제 종료 시키는데, OOM-Killer는 메모리를 가장 많이 잡아먹는 프로세스를 종료 시키기에 MySQL 서버가 종료 1순위가 될 것이다.

즉 소트 버퍼 사이즈 너무 키우면 서버가 강제 종료될 확률이 높아진다는 것이다. 

# 핵심 요약
- 소트 버퍼는 결과값 정렬을 위해 세션 메모리에 임시 할당되는 메모리 공간이다.
- 소트 버퍼를 활용한 정렬 과정은 다음과 같이 이루어진다. 
	- 버퍼 사이즈만큼의 레코드 정렬 (quick sort)
	- 해당 부분 정렬된 레코드들은 임시 파일 형태로 디스크에 저장
	- 임시 파일들에 대하여 merge sort 진행
- 소트 버퍼 사이즈를 늘린다고 해서 성능에 도움은 안되고 오히려 MySQL 서버 강제 종료될 확률만 높인다.

---

# Metadata

### A. 모르는 단어 정리 
- `세션 메모리 vs 글로벌 메모리`
	- 세션 메모리: 해당 세션의 포그라운드 스레드만 활용할 수 있는 메모리 영역
	- 글로벌 메모리: MySQL 서버 내의 모든 스레드가 활용할 수 있는 공용 메모리 영역

###  B. 참고 문서

### C. 관련 글

```dataview
TABLE without id file.inlinks AS "BackLink"
WHERE file.path = this.file.path
```
