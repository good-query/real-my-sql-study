---
tags:
  - 데이터베이스
  - cs
parent: "[[쿼리 최적화]]"
related:
  - "[[B-Tree 인덱스를 통한 데이터 읽기 방식의 종류]]"
created: 2025-06-24
---

# 0. 학습 목적
- 옵티마이저가 특정 데이터 읽기 방식이 적합하다고 판단하는 과정을 이해한다.

# 1. 옵티마이저의 데이터 읽기 방식  판단 기준
옵티마이저는 미리 계산된 인덱스 통계 정보를 통해 다음을 정한다.

- 어떤 인덱스를 활용하여 질의문을 연산할 것인지 (혹은 인덱스를 활용하긴 할 것인지)
- 세부적으로 어떤 읽기방식을 활용할 것인지 (읽기 방식 종류: [[B-Tree 인덱스를 통한 데이터 읽기 방식의 종류]] 참고)

## (1) 인덱스 통계 정보는 어떻게 알까? 
MySQL 엔진이 **`샘플링 기반`** 으로 테이블의 모든 인덱스에 대한 통계 정보를 계산한다. 

### A. 인덱스 통계 정보 계산 과정
**0 단계, 샘플링할 페이지 설정**
	- 영구적인 통계 설정을 켜놨을 시 샘플 페이지 수는 20개
	- 영구적인 통계 꺼뒀을 시 혹은 특정 테이블을 `STATS_PERSISTENT=0` 로 영구 통계 사용 안함으로 만들거나 설정 변경 했을 시, 샘플 페이지 수는 8개
	  (영구통계 = disk 저장, 임시 통계 = 메모리 저장)

**1 단계, 통계를 내려는 테이블의 모든 인덱스 페이지 읽기**
	- 테이블에 존재하는 인덱스마다, 위에 설정한 샘플 페이지 수만큼 랜덤하게 페이지를 읽어들인다.

**2 단계, 샘플링 기반 통계 자료 만들기**
	- `n_diff_pfx01`: 인덱스 키의 고유 값 수
	- `n_leaf_pages`: 리프 페이지 수
	- `size`: 인덱스 전체 페이지 수

### B. 인덱스 통계 정보 재 계산 조건
1. 서버 재부팅 시
2. 개발자가 `analyze table`로 수동으로 통계 정보 수집을 요청했을 때
3. 테이블의 데이터가 10% 이상 변경 되었을 경우
4. 개발자가 메타데이터를 조회할 시 (`SHOW TABLE STATUS` 나 `inno_db_stats_on_metadata=ON` )

> [!info] 샘플링 페이지 설정 권장 사항 (in 공식 문서) 
> - 페이지 수를 1개나 2개로 엄청 작게 잡으면 통계 정보가 부정확해서 옵티마이저가 오판하기 쉽다. 
> - 페이지 수를 100개 정도로 크게 잡으면 인덱스 정확도는 상당히 높아지나, 디스크 READ 작업이 많이 늘게 되어, 테이블 전체 열기, 수동 재계산 명령어 사용 할 시 성능 저하의 주된 원인이 된다. 
>   -> 현 스토리지 엔진 내 모든 테이블 샘플링이 해당 설정을 따라가므로

# 2. 테이블 풀 스캔이 선택되는 상황
1. 테이블 전체 레코드 건 수가 작아서 어짜피 접근해야할 페이지 수가 작은 경우
2. 마땅히 인덱스 탈 조건이 없는 경우
3. 인덱스 탈 조건이 있긴 있는데, 조건문과 일치하는 레코드 건 수가 많아서, 인덱스 타는 것이 오히려 비효율 적일 때.

# 3. 인덱스 풀 스캔이 선택되는 상황
보조 인덱스를 전부 확인하면, **본 테이블 안 가고** 질의문을 충족 시킬 수 있는 상황

### A. 예시
- 질의문에 필요한 모든 요건들을 만족시키는 커버링 인덱스가 존재
- COUNT( * ) 형태로 레코드 건 수만 세는 경우 

### B. InnoDB에서는 어짜피 기본 데이터 저장도 B-Tree 기반으로 보조 인덱스랑 형태가 같은데, 풀 인덱스 스캔 탈 필요 없는 거 아니야?
NO! 

보조 인덱스는 저장하는 컬럼의 값이 클러스터링 인덱스 보다 작다. (보조 = 필요한 것만, 클러스터 = 레코드 전체 내용 저장)
따라서 보조인덱스의 전체 용량은 클러스터링 인덱스보다 작고, 이 덕분에, 보조인덱스 저장에 쓰인 페이지 수가 작아서 디스크 읽기 횟수가 비교적 작다.

이 때문에 인덱스 풀 스캔으로 (**본 테이블에 대한 추가 접근 없이**) 질의문을 끝낼 수 있다면, 인덱스 풀 스캔이 훨씬 효율적이다.

# 핵심 요약
- 옵티마이저는 인덱스 통계정보와 COST MODEL, 테이블 통계 정보 (데이터 분포도)를 종합적으로 판단하여, 현재 요청된 질의문에 대한 읽기 방식을 결정한다.
- 인덱스 통계 정보는 샘플링 기반으로 데이터를 수집한다. 테이블의 페이지 중 랜덤으로 뽑는다. -> 카디널리티, 리프 페이지 수 등 자룔르 뽑는다.

---

# Metadata

### A. 모르는 단어 정리 

###  B. 참고 문서
- [MySQL 공식문서: full table scan 피하기](https://dev.mysql.com/doc/refman/8.4/en/table-scan-avoidance.html)
- [옵티마이저의 영구 통계 파라미터 설정하기](https://dev.mysql.com/doc/refman/8.4/en/innodb-persistent-stats.html)
- [ 옵티마이저의 임시 통계 파라미터 설정하기](https://dev.mysql.com/doc/refman/8.4/en/innodb-statistics-estimation.html)

### C. 관련 글

```dataview
TABLE without id file.inlinks AS "BackLink"
WHERE file.path = this.file.path
```
