<h1 align='center'>7.5 바이너리 로그 암호화</h1>

### 0. 필요성

- 리두 로그, 언두로그보다 데이터 보관 시간이 길다. 따라서 바이너리 로그 암호화 중요도는 앞의 두 개에 비해 높아질 수 있다.

### 0. 암호화 지점

- 바이너리 로그에 대한 암호화는 디스크에 저장된 데이터에 대해서만 이루어진다. (즉 레플리카 복제될 때, 네트워크 구간에서는 평문으로 오고가고 무방비 상태)
- 만약 네크워크 구간에서도 바인러ㅣ 로그 암호화를 하고자 한다면,  MySQL 복제를 위한 계정이 SSL을 사용하도록 하면 된다. 

## 1. 바이너리 로그 암호화 키 관리 

> 테이블 데이터 암호화와 같이 2단계 키 관리 아키텍처 활용

- `파일 키`: 테이블 데이터 암호화에서의 *테이블 스페이스 키* 와 같은 역할을 한다. 즉 바이너리 로그나 릴레이 로그 파일의 데이터를 암호화 한다. 
- `바이너리 로그 암호화 키`: 마스터 키역할과 같다. 즉 파일 키를 암호화 한다. 
- 암호화된 파일키는 자신이 암호화 했던 바이너리 로그 혹은 릴레이 로그의 헤더에 저장된다. (즉 암호화 원리와 역할 모두 테이블 데이터 암호화와 같음)

## 2. 바이너리 로그 암호화 키 변경

1. 증가된 시퀀스 번호와 함께 새로운 바이너리 로그 암호화 키 발급 후 키링에 저장  
2. 바이너리 로그 파일과 릴레이 로그 스위치  
3. 새로 생성되는 바이너리 로그와 릴레이 로그 파일의 암호화를 위해 파일 키 생성, 파일 키는 바이너리 로그 암호화 키(마스터 키) 로 암호화 해서 각 바이너리 로그  파일에 저장
4. 기존 바이너리 로그와 릴레이 로그 파일의 파일 키를 읽어서 새로운 바이너리 로그 파일 키로 암호화해서 다시 저장 (암호화 되지 않은 파일 키는 무시)  
5. 모든 바이너리 로그와  릴레리오 로그 파일이 새로운 바이너리 로그 암호화 키로 다시 암호화 되었다면 기존 바이너리 로그 암호화 키를 키링 파일에서 제거 

### A. 시퀀스 번호란?

바이너리 암호화 키의 버전 관리를 위해 암호화 키를 바꿀 때마다 시퀀스 넘버 (버전 넘버)를 1씩 증가시켜서 구분함.
### B. 스위칭

스위칭은 말 그대로 옛 파일을 새 파일로 바꾼다는 의미



## 3. mysqlbinlog 도구 활용

### A. mysqlbinlog 라는 명령어 도구란?

바이너리 로그 파일을 읽을 수 있는 언어로 변환해주는 도구 (= 기계어 번역기)
바이너리 로그는 이진 포맷이라 사람이 읽을 수 없기에, 해당 도구를 쓰면 SQL 형태로 변환되어져서 사람이 볼 수 있음.

### B. 암호화랑 무슨 상관? 

mysqlbinlog 도구는 복호화 기능도 같이 지원
다만, 복호화를 하려면 MySQL 서버에 요청해서 복호화를 위한 바이너리 로그 암호화 키 (= Master Key) 역할도 같이 가져와야 한다.



---

### 용어 정리

- `바이너리 로그`: 마지막 백업 이후의 변경 사항들(Insert, Update, Delete)을 저장해놓는 로그,
  - 저장 시점: 쿼리가 성공하면 -> 바이너리 로그에 기록 -> 이후 본 데티어 파일을 업데이트
    (Auto Commit 모드가 아니면 트랜잭션 commit 시점에 파일을 업데이트)
  - 사용 용도: 복구(백업 용), 복제(레플리카 서버 운영용), 감사(누가 어떤 쿼리 날렸는지 감사용)
- `증분 백업`: 지난 번에 백업한 이후 변경된 내용만 추가로 백업하는 방식 (반의어 - 전체 백업)
  바이너리 로그 자체가 특정 시간 이후로 어떤 SQL 문이 실행되어서 DB가 어떻게 바뀌었는지를 기록한 바이너리 로그 파일 이므로, 바이너리 로그를 저장한다 = 증분 백업을 하겠다는 의미