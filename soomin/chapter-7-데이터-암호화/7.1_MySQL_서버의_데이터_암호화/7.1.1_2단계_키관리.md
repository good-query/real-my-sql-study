<h1 align = 'center'>7.1.1 2단계 키 관리</h1>

**`KEY WORD`: 2 계층의 Key를 이용해 암호화/복호화 하는 절차, 왜 하는지**

# 1. 2단계 키 관리 아키텍쳐

다음과 같이 키를 2계층으로 분리하여 관리하는 설계 방식, 각 계층 키의 용도는 다음과 같다.

- **`하위: 테이블 스페이스 Key`**: 테이블 자체를 암 / 복호화 하기 위한 Key, 메타데이터로 자신이 맡은 테이블의 데이터 파일 헤더에 저장됨.
- **`상위: 마스터 키`**: 위의 테이블 스페이스 Key를 암/복호화 하는 Key

# 2. 과정

## (1) 암호화

1. Keyring_file이건 keyring_valut 이건 사용하는 키링 플러그인을 통해 DB 서버에 외부에 존재하는 마스터 키를 주입받는다. 
2. 테이블 하나를 암호화할 때마다, 해당 테이블을 위한 임의의 테이블 스페이스 키를 하나 발급한다.
3. 해당 테이블 스페이스 키로 테이블 하나를 암호화 했다면, 이제 마스터 키를 활용해서 테이블 스페이스 키를 암호화하고, 해당 테이블의 데이터 파일 헤더에 저장한다.
4. 암호화된 테이블을 Disk에 적재한다.

## (2) 복호화

1.  마스터 키 외부 주입 후 DB 서버 한 켠에 적재 
2. 테이블 하나 복호화 하려고 하면 먼저 해당 테이블의 데이터 파일 헤더에서 암호화된 테이블 스페이스 키를 가지고 온다.
3. 마스터 키로 해당 테이블 스페이스 키를 복호화 한다.
4. 복호화한 테이블 스페이스 키로 테이블을 복호화 한다.
5. 복호화가 끝난 테이블은 Buffer pool에 적재한다.

# 3. 이렇게 2단계로 계층을 나눠 암호화, 복호화를 진행하는 이유

> 결론: **암호화 키 변경 시 과도한 CPU 부하를 피하기 위해서**

만약 하나의 마스터키로 모두 진행한다면?
키를 변경할 때마다, 모든 테이블을 꺼내와서 다시 복호화 및 암호화 해야 한다. 이는 막대하게 큰 테이블 전체에 대해 매번 진행하기 떄문에 CPU 부하를 높인다. 

두 개로 나누면? 
테이블 스페이스 키는 다음과 같은 이유로 안전하다.

- 디스크가 털려도, 테이블 스페이스 키 자체도 복호화 되어 있기 때문에, 해커가 내용물을 복호화 할 수 없다. 
- 테이블 스페이스 헤더에 저장되어 있어서 테이블과 생애주기를 같이 한다. 따로 생성과 삭제 관리를 할 필요가 없다. 

따라서 2단계 키관리에서는 **마스터 키만** 정기적으로 바꿔주면 된다. 이렇게 된다면, 

- 마스터 키가 바뀔 때마다 모든 테이블을 돌면서 해당 테이블 헤더의 테이블 스페이스 키만 복호화 및 재 암호화를 거치면 된다. 따라서 CPU 부하가 1단계 아키텍쳐보다 괄목할만하게 줄어든다.

# 4. 마스터 키와 테이블 스페이스 키의 암호화 / 복호화 알고리즘

> 결론: **이 둘은 대칭키 알고리즘인 AES-256 알고리즘을 활용해 자신의 대상 데이터를 암호화 혹은 복호화 한다.**

## (1) 마스터키가 테이블 스페이스 키를 암호화 할 때

AES-256 ECB 알고리즘 활용

## (2) 테이블 스페이스 키가 실제 데이터 암호화 할 때

AES-256 CBC 알고리즘 활용

# 5. 추가학습 (1) 마스터 키 주입 방법에 대해

책에서 소개하는 마스터 키 주입 방법은 mySQL 기본 지원 키링 플러그인 서비스인 key_ring 퍄일 이용과 엔터프라이즈 이상에서만 지원하는 valut 라는 외부 키 관리 시스템 이용 2가지가 있었다. 이에 대해 알아보겠다.

## (1) Keyring-file 활용 시

다음과 같은 디스크의 로컬 파일에서 Keyring file을 읽어와서 메모리에 적재

```bash
early-plugin-load=keyring_file.so
keyring_file_data=/var/lib/mysql-keyring/keyring
```

TDE의 장점은 디스크가 털려도 보안의 관심사 분리 때문에, 해커가 해당 내용을 까볼 수 없어 안전하다는 건데, 이건 마스터 키도 디스크에 있어서 털리면 TDE의 장점을 활용할 수 없다.

필자 생각엔 커뮤니티 버전에서 Keyring service를 한 번 활용해 보라고 MySQL 측에서 만든 것인거 같다.

## (2) Valut 같은 외부 키 관리 시스템에서 주입 시

- HTTPS API로만 Vault 서버와 소통 (기본적으로 Vault 서버를 띄우더라도, 해당 서버가 Https 인증을 못 받았다면 API 통신 자체를 못하게 막아놓음)
- DB 서버 부팅 시 API 1회 호출 후 메모리 적재가 기본 사용 방식이다. (서비스에 따라서, 메모리에서의 생명주기, API 통신 주기를 설정한다.)

이는 TDE의 장점을 그대로 가져갈 수 있다.

