## 4.4 MySQL 로그 파일

### 4.4.1 에러 로그 파일
MySQL이 실행되는 도중에 발생하는 에러나 경고 메시지가 출력되는 로그 파일이다.

에러 로그 파일의 위치는 MySQL 설정 파일(`my.cnf`)에서 `log_error` 라는 이름의 파라미터로 정의된 경로에 생성된다. <br>
별도로 정의되지 않은 경우에는 데이터 디렉터리에 `.err` 확장자가 붙은 파일로 생성된다. <br>

<br>

**1️⃣ MySQL이 시작하는 과정과 관련된 정보성 및 에러 메시지**
<br>

MySQL의 설정 파일을 변경하거나 데이터베이스가 비정상적으로 종료된 이후 다시 시작하는 경우 
반드시 MySQL 에러 로그 파일을 통해 설정된 변수의 이름이나 값이 명확하게 설정되고 의도한 대로 적용됐는지 확인해야 한다.

- MySQL 서버가 정상적으로 기동됐고, 새로 추가하거나 변경한 파라미터에 대해 에러나 경고성 메시지가 없다면 정상!
- 특정 변수가 무시된 경우에는 해당 파라미터는 MySQL에 적용되지 못했음을 의미한다.
- 변수명을 인식하지 못하거나 설정된 파라미터 값의 내용을 인식하지 못하는 경우에는 MySQL 서버가 에러 메시지를 출력하고 시작하지 못했다는 메시지를 보여줄 것이다.

<br>

**2️⃣ 마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB의 트랜잭션 복구 메시지**
<br>

InnoDB는 MySQL 서버가 비정상적 또는 강제적으로 종료된 경우 <br>
다시 시작되면서 완료되지 못한 트랜잭션을 정리하고 디스크에 기록되지 못한 데이터가 있다면 다시 기록하는 재처리 작업을 한다. <br>
이 과정에 대한 간단한 메시지가 출력되는데, 간혹 문제가 있어서 복구되지 못할 때는 해당 에러 메시지를 출력하고 MySQL은 다시 종료될 것이다. <br>

<br>

**3️⃣ 쿼리 처리 도중에 발생하는 문제에 대한 에러 메시지**
<br>

쿼리의 실행 도중 발생한 에러나 복제에서 문제가 될 만한 쿼리에 대한 경고 메시지가 에러 로그에 기록된다. <br>
따라서 에러 로그 파일을 자주 검토하도록 하자. <br>

<br>

**4️⃣ 비정상적으로 종료된 커넥션 메시지(Aborted connection)**
<br>

클라이언트 애플리케이션에서 정상적으로 접속 종료를 하지 못하고 프로그램이 종료된 경우 에러 로그에 기록된다. <br>
이런 메시지가 자주 기록된다면 애플리케이션의 커넥션 종료 로직을 한번 검토해볼 필요가 있다. <br>

- `max_connect_errors` 값이 너무 낮게 설정된 경우 클라이언트 프로그램이 MySQL 서버에 접속하지 못하고 "Host 'host_name' is blocked" 라는 에러가 발생할 수도 있다.
  => 값을 증가시키면 된다. 하지만 원인을 살펴보는 것이 좋다.

<br>

**5️⃣ InnoDB의 모니터링 또는 상태 조회 명령(SHOW ENGINE INNODB STATUS와 같은)의 결과 메시지**
<br>

InnoDB의 모니터링 또는 상태 조회 명령은 상대적으로 큰 메시지를 에러 로그 파일에 기록한다. <br>
따라서 모니터링을 사용한 이후 다시 비활성화해서 에러 로그 파일이 커지지 않게 만들어야 한다. <br>

<br>

**6️⃣ MySQL의 종료 메시지**
<br>

MySQL이 아무도 모르게 종료되어 있거나 재시작되는 경우 에러 로그 파일에 출력된 메시지를 확인해야 한다. <br>
누군가 종료시켰다면 'Received SHUTDOWN from user ...' 이라는 메시지를 확인할 수 있다. <br>
아무런 종료 관련 메시지가 없거나 스택 트레이스와 같은 내용이 출력되는 경우 Segmentation fault로 비정상적으로 종료된 것이다. <br>

> 💡 Segmentation fault의 주요 원인 <br>
> 1) MySQL 자체나 플러그인에 버그가 있을 경우(특히 오래된 버전) or 잘못된 메모리 접근
> 2) 메모리가 부족하거나 손상된 상태 or 커널/시스템이 비정상 상태
> 3) 디스크나 테이블 손상
> 4) 비정상 설정 (my.cnf 설정에 무리한 값이 들어가 있을 경우)
> 5) 하드웨어 문제

<br>

### 4.4.2 제너럴 쿼리 로그 파일(제너럴 로그 파일, General log)
쿼리 로그를 활성화하면 쿼리를 쿼리 로그 파일로 기록한다. 쿼리 로그 파일에는 시간 단위로 실행됐던 쿼리의 내용이 모두 기록된다. <br>
제너럴 쿼리 로그는 실행되기 전에 MySQL이 쿼리 요청을 받으면 바로 기록하기 때문에 실행 도중 에러가 발생해도 일단 로그 파일에 기록된다. <br>

쿼리 로그 파일의 경로는 `general_log_file` 파라미터에 설정되어 있다. <br>
```sql
mysql> SHOW GLOBAL VARIABLES LIKE 'general_log_file';
```
![image](https://github.com/user-attachments/assets/27a9976a-218a-4b14-bafd-5d721efd9022)

<br>

### 4.4.3 슬로우 쿼리 로그
슬로우 쿼리 로그는 기준 시간(`long_query_time`)보다 오래 걸린 쿼리를 기록한다. <br>
MySQL이 쿼리를 실행한 후 실제 소요된 시간을 기준으로 기록 여부를 판단하기 때문에 반드시 쿼리가 정상적으로 실행이 완료되어야 기록된다. <br>

`log_output` 파라미터를 `TABLE`로 설정하면 쿼리 로그를 테이블에 저장하고, `FILE`로 설정하면 파일에 저장한다. 
하지만 테이블로 저장하더라도 MySQL의 `slow_log` 테이블과 `general_log` 테이블은 CSV 스토리지 엔진을 사용하기 때문에 결국 CSV 파일로 저장하게 된다. <br>
<br>

슬로우 쿼리 로그 파일 내용을 살펴보자.
- `Time`: 쿼리가 종료된 시점
- `User@Host`: 쿼리를 실행한 사용자의 계정
- `Query_time`: 쿼리가 실행되는 데 걸린 전체 시간
- `Lock_time`: MySQL 엔진 레벨에서 관장하는 테이블 잠금에 대한 대기 시간만 표현.
  실제 쿼리가 실행되는 데 필요한 잠금 체크와 같은 코드 실행 부분의 시간까지 포함되기 때문에 이 값이 0이 아니라고 해서 무조건 잠금 대기가 있었다고 판단하기는 어렵다.
- `Row_examined`: 해당 쿼리가 처리되기 위해 몇 건의 레코드에 접근했는지
- `Rows_sent`: 실제 몇 건의 처리 결과를 클라이언트로 보냈는지

<br>

MyISAM이나 MEMORY 스토리지 엔진과 같은 경우 MySQL 엔진 레벨의 잠금만 가지고, <br>
InnoDB의 경우 MySQL 엔진 레벨의 잠금과 스토리지 엔진 자체 잠금을 가지고 있다. <br>

![image](https://github.com/user-attachments/assets/a46809f9-b6e9-4188-a2e2-6e60f4733207)
- MyISAM이나 MEMORY 스토리지 엔진에서는 테이블 단위의 잠금을 사용하고 MVCC와 같은 메커니즘이 없기 때문에 SELECT 쿼리에 대해서도 `Lock_time`이 1초 이상 소요될 가능성이 있다.
- 하지만 InnoDB 테이블에 대한 SELECT 쿼리의 경우에도 상대적으로 큰 값이 발생할 수 있는데, 이는 InnoDB의 레코드 수준의 잠금이 아닌 MySQL 엔진 레벨에서 설정한 테이블 잠금 때문일 가능성이 높다.
  따라서 InnoDB 테이블에만 접근하는 쿼리 문장의 슬로우 쿼리 로그에서는 `Lock_time` 값이 튜닝이나 쿼리 분석에 별로 도움이 되지 않는다.

