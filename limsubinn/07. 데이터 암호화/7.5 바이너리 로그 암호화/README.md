## 7.5 바이너리 로그 암호화
테이블 암호화가 적용되어도 바이너리 로그와 릴레이 로그는 평문으로 저장한다.
<br>

바이너리 로그와 릴레이 로그 파일 암호화 기능은 디스크에 저장된 로그 파일에 대한 암호화만 담당하고, <br>
MySQL 서버의 메모리 내부 또는 소스 서버와 레플리카 서버 간의 네트워크 구간에서 로그 데이터를 암호화하지는 않는다. <br>
복제 멤버 간의 네트워크 구간에서도 바이너리 로그를 암호화하고자 한다면 MySQL 복제를 위한 계정이 SSL을 사용하도록 설정하면 된다.

<br>

### 7.5.1 바이너리 로그 암호화 키 관리
2단계 암호화 키 관리 방식을 사용한다.
<br>

파일 키로 암호화해서 디스크로 저장하고, <br>
파일 키는 "바이너리 로그 암호화 키"로 암호화해서 각 바이너리 로그와 릴레이 로그 파일의 헤더에 저장된다.

<br>

### 7.5.2 바이너리 로그 암호화 키 변경
```sql
mysql> ALTER INSTANCE ROTATE BINLOG MASTER KEY;
```
1. 증가된 시퀀스 번호와 함께 새로운 바이너리 로그 암호화 키 발급 후 키링 파일에 저장
2. 바이너리 로그 파일과 릴레이 로그 파일 스위치 (새로운 로그 파일로 로테이션)
3. 새로 생성되는 바이너리 로그와 릴레이 로그 파일의 암호화를 위해 파일 키를 생성하고, 파일 키는 바이너리 로그 파일 키로 암호화해서 각 로그 파일에 저장
4. 기존 바이너리 로그와 릴레이 로그 파일의 파일 키를 읽어 새로운 바이너리 로그 파일 키로 암호화해서 다시 저장 (암호화되지 않은 로그 파일은 무시)
5. 모든 바이너리 로그와 릴레이 로그 파일이 새로운 바이너리 로그 암호화 키로 다시 암호화됐다면 기존 바이너리 로그 암호화 키를 키링 파일에서 제거
<br>

바이너리 로그 암호화 키는 내부적으로 버전(시퀀스 번호) 관리가 이루어진다. <br>
예를 들어, MySQL 서버에서 바이너리 로그 암호화 키 변경(로테이션) 명령을 연속으로 2번 실행했다면 <br>
키링 파일에는 순차적인 시퀀스 번호를 가지는 3개의 바이너리 로그 암호화 키가 존재할 것이다. <br>
그리고 바이너리 로그와 릴레이 로그 파일들은 최근 순서대로 파일 키를 다시 암호화해서 저장하는 작업을 수행한다.

<br>

바이너리 로그 파일이 암호화되어 있는지 여부는 다음과 같이 확인할 수 있다.
```sql
mysql> SHOW BINARY LOGS;
```
![image](https://github.com/user-attachments/assets/45d70024-f809-4980-8e4b-bb573785f6aa)

<br>

### 7.5.3 mysqlbinlog 도구 활용
MySQL 서버에서는 트랜잭션의 내용을 추적하거나 백업 복구를 위해 암호화된 바이너리 로그를 평문으로 복호화할 일이 자주 발생한다. <br>
하지만 한 번 바이너리 로그 파일이 암호화되면 바이너리 로그 암호화 키가 없으면 복호화할 수 없다. <br>
그런데 바이너리 로그 암호화 키는 MySQL 서버만 가지고 있다. <br>

그나마 바이너리 로그 파일의 내용을 볼 수 있는 방법은 MySQL 서버를 통해 가져오는 방법이 있다. <br>
mysqlbinlog 도구가 MySQL 서버에 접속해서 바이너리 로그를 가져오는 것이다.
```shell
mysqlbinlog --read-from-remote-server -uroot -p -vvv binlog.000020
```
- `--read-from-remote-server`: 서버에서 직접 binlog를 읽어오겠다는 의미
- `-vvv`: 로그를 매우 자세하게(verbose) 출력
