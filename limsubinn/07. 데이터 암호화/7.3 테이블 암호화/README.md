## 7.3 테이블 암호화

### 7.3.1 테이블 생성
```sql
mysql> CREATE TABLE tab_encrypted (
         id INT,
         data VARCHAR(100),
         PRIMARY KEY(id)
       ) ENCRYPTION='Y';
```
일반적인 테이블 생성 구문과 동일하며, 마지막에 `ENCRYPTION = 'Y'` 옵션만 추가로 넣으면 된다. <br>
그러면 이 테이블의 데이터가 디스크에 기록될 때는 데이터가 자동으로 암호화되어 저장되고, 디스크에서 메모리로 읽어올 때 복호화된다.
<br>

MySQL 서버의 모든 테이블에 대해 암호화를 적용하고자 한다면 `default_table_encryption` 시스템 변수를 `ON`으로 설정하면 된다.

<br>

### 7.3.2 응용 프로그램 암호화와의 비교
응용 프로그램에서의 암호화는 보통 컬럼 단위에 적용되고, MySQL 서버에서의 암호화는 테이블 단위로 적용된다.
<br>

응용 프로그램에서 직접 암호화해서 MySQL 서버에 저장하는 경우, 인덱스의 기능을 100% 활용할 수 없다. <br>
왜냐하면 MySQL 서버는 이미 암호화된 값을 기준으로 정렬했기 때문에 암호화되기 전의 값을 기준으로 정렬할 수가 없다. <br>
하지만 응용 프로그램에서 직접 암호화하지 않고 MySQL 서버의 암호화 기능(TDE)을 사용한다면 이 같은 제약은 없다.
<br>

반면, MySQL 서버의 TDE 기능으로 암호화하면 실행 중인 MySQL 서버에 로그인한 사용자는 모든 데이터를 평문으로 확인할 수 있다. <br>
하지만 응용 프로그램 암호화는 로그인한 사용자도 평문의 내용을 확인할 수 없다.
<br>

따라서 응용 프로그램과 MySQL 서버에서의 암호화 기능을 서비스의 요건과 성능을 고려하여 잘 선택하도록 하자.

<br>

### 7.3.3 테이블스페이스 이동
테이블을 다른 서버로 복사해야 하는 경우 또는 특정 테이블의 데이터 파일만 백업했다가 복구하는 경우, <br>
테이블스페이스 이동(Export & Import) 기능이 레코드를 덤프했다가 복구하는 방식보다 훨씬 효율적이고 빠르다.

<br>

```sql
mysql> FLUSH TABLES source_table FOR EXPORT;
```
FLUSH TABLES 명령을 통해 테이블스페이스를 export할 수 있다.

<br>

**✅ 암호화되지 않은 테이블의 복사 과정**
1. `FLUSH TABLES` 명령이 실행되면 MySQL 서버는 해당 테이블의 저장되지 않은 변경 사항을 모두 디스크로 기록하고, 테이블에 접근할 수 없게 잠금을 건다.
2. 그와 동시에 테이블의 구조를 `source_table.cfg` 파일로 기록해둔다.  
3. 그러면 `source_table.ibd` 파일과 `source_table.cfg` 파일을 목적지 서버로 복사한다.
4. 복사가 모두 완료되면 `UNLOCK TABLES` 명령을 실행해 source_table을 사용할 수 있게 하면 된다.

<br>

**💡 참고**
|파일명|역할|
|---|---|
|`source_table.ibd`|실제 테이블 데이터 + 인덱스가 저장된 파일|
|`source_table.cfg`|테이블 메타데이터 정보|

<br>

**✅ 암호화된 테이블의 복사 과정**
1. `FLUSH TABLES` 명령이 실행되면 MySQL 서버는 임시로 사용할 마스터 키를 발급해서 `source_table.cfp` 파일로 기록한다.
2. 그리고 암호화된 테이블의 테이블스페이스 키를 기존 마스터 키로 복호화한 후, 임시로 발급한 마스터 키를 이용해 다시 암호화해서 데이터 파일의 헤더 부분에 저장한다.
3. 따라서 암호화된 테이블의 경우 테이블 스페이스 이동 기능을 사용할 때 **반드시 `*.cfp` 파일도 함께 복사해야 한다.**
